Guava Cache Stats Counter Micro Benchmark
=========================================

Available here: https://github.com/al3ks/cachestatsmicrobench

Aim
---

Purpose of this experiment is to determine the most efficient means of implementing a high performance counter that can be used in heavily multithreaded applications.

The subjects in this experiment are:
    * Control - A simple counter that uses a primitive long and synchronized methods.
    * Striped64 - A counter based on Doug Lea's Stripe64 class (and LongAdder wrapper class).
    * Atomic - An implementation using atomic logs.
    * StripedLocalLong - My own implementation inspired by Stripe64 with the aim of not using sun.misc.Unsafe methods
    * StripedAtomicLong - An alternative using striped atomic longs.
    * StripedLockLock - Another alternative using striped locks and primitive longs.

Setup
-----

Hardware:
    * QuadCore Intel Core i7-2600K, 4200 MHz (42 x 100) (Hyperthreading Enabled)
    * Asus Maximus IV Extreme-Z  Mobo
    * Intel Cougar Point Z68, Intel Sandy Bridge
    * 16281 MB RAM  (DDR3 1998 MHz)

Software:
    * Microsoft Windows 7 Ultimate 6.1.7601.17944 (Win7 RTM)
    * Oracle JDK 1.6.0_37 (64-bit)

Test
----

Implemented here: https://github.com/al3ks/cachestatsmicrobench/blob/master/src/main/java/CacheStatsMicroBench.java

Other than the Control, the tests are run twice just to shake off any temporal artifacts. You can assume the "real" number is between the two values.

Conclusion
----------

To my surprise my StripedLocalLong implemetation was actually the winner by a reasonable margin. Closely followed by the Striped64 implementation. The atomic implementation performed worse than expected, and you can see contention kills it's
performance as the threads are increased.

I have released the StripedLocalLong implementation and variants under the Apache License. Feel free to use it wherever. Would also be happy to find it a home in a library somewhere.

StripedLocalLong has very good performance up to 4 threads (there are 4 cores on my test machine), then performance starts to degrate with 8+ threads, however it's still performs the best of the bunch.

Results
-------


Threads=1
  Control          Duration=1.0260s

  Atomic1          Duration=0.4990s
  StripedAtomic1   Duration=1.3700s
  StripedLock1     Duration=1.3740s
  Striped641       Duration=0.5730s
  StripedLocal1    Duration=0.3590s

  Atomic2          Duration=0.5230s
  StripedAtomic2   Duration=0.5260s
  StripedLock2     Duration=0.5240s
  Striped642       Duration=0.5680s
  StripedLocal2    Duration=0.4870s

Threads=2
  Control          Duration=4.2630s

  Atomic1          Duration=2.4410s
  StripedAtomic1   Duration=0.6420s
  StripedLock1     Duration=0.5890s
  Striped641       Duration=0.9050s
  StripedLocal1    Duration=0.4920s

  Atomic2          Duration=2.4980s
  StripedAtomic2   Duration=0.6170s
  StripedLock2     Duration=0.7480s
  Striped642       Duration=0.8580s
  StripedLocal2    Duration=0.4650s

Threads=4
  Control          Duration=9.1030s

  Atomic1          Duration=6.1930s
  StripedAtomic1   Duration=1.0700s
  StripedLock1     Duration=1.2100s
  Striped641       Duration=1.1230s
  StripedLocal1    Duration=0.6560s

  Atomic2          Duration=5.6960s
  StripedAtomic2   Duration=1.1060s
  StripedLock2     Duration=1.2010s
  Striped642       Duration=1.2160s
  StripedLocal2    Duration=0.6530s

Threads=8
  Control          Duration=18.0370s

  Atomic1          Duration=14.8730s
  StripedAtomic1   Duration=1.7750s
  StripedLock1     Duration=1.8620s
  Striped641       Duration=1.6390s
  StripedLocal1    Duration=1.8080s

  Atomic2          Duration=13.0530s
  StripedAtomic2   Duration=1.7410s
  StripedLock2     Duration=1.8340s
  Striped642       Duration=1.8050s
  StripedLocal2    Duration=1.6430s

Threads=16
  Control          Duration=36.4360s

  Atomic1          Duration=28.0890s
  StripedAtomic1   Duration=3.2120s
  StripedLock1     Duration=3.2030s
  Striped641       Duration=3.4780s
  StripedLocal1    Duration=3.2470s

  Atomic2          Duration=26.8560s
  StripedAtomic2   Duration=3.1340s
  StripedLock2     Duration=3.1530s
  Striped642       Duration=3.3760s
  StripedLocal2    Duration=3.7800s